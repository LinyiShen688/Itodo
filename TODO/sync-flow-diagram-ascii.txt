┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    iTodo 混合存储同步流程图                                │
└─────────────────────────────────────────────────────────────────────────────────────────┘

1️⃣ 未登录状态（Local-Only Mode）
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│   用户操作                     IndexedDB                    SyncQueue      Supabase     │
│   ┌─────┐                   ┌──────────┐                 ┌─────────┐    ┌─────────┐   │
│   │ ADD │ ─────────────────►│ tasks    │                 │ (empty) │    │   N/A   │   │
│   │TASK │  userId: null     │ taskLists│                 └─────────┘    └─────────┘   │
│   └─────┘                   └──────────┘                                               │
│                               ▲                                                         │
│                               │ 立即写入                                                 │
│                               │ deleted: 0/1/2                                          │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

2️⃣ 用户登录触发同步（Login Sync Process）
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│   登录事件                    处理流程                                                    │
│   ┌──────┐                                                                             │
│   │LOGIN │──────► onUserLogin() ──────► 1. processNullUserIdData()                    │
│   └──────┘                              2. pullRemoteData()                            │
│                                         3. applyRemoteData()                           │
│                                         4. processQueue()                              │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

3️⃣ 详细同步步骤
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│  Step 1: processNullUserIdData (处理本地未同步数据)                                      │
│  ┌────────────────┐     ┌──────────────┐     ┌─────────────┐                         │
│  │  IndexedDB     │     │ Update userId │     │  SyncQueue  │                         │
│  │                │     │              │     │             │                         │
│  │ userId: null ──┼────►│ userId: 123  │────►│ ADD items   │                         │
│  │                │     │              │     │ (pending)   │                         │
│  └────────────────┘     └──────────────┘     └─────────────┘                         │
│                                                                                         │
│  Step 2: pullRemoteData (拉取云端数据)                                                  │
│  ┌────────────────┐                          ┌─────────────┐                         │
│  │   Supabase     │                          │   Local     │                         │
│  │                │                          │   Memory    │                         │
│  │ GET tasks      │─────────────────────────►│ remoteTasks │                         │
│  │ GET taskLists  │  since last_pull_time    │ remoteLists │                         │
│  └────────────────┘                          └─────────────┘                         │
│                                                                                         │
│  Step 3: applyRemoteData (应用远程数据，LWW冲突解决)                                     │
│  ┌────────────────┐     ┌──────────────┐     ┌─────────────┐                         │
│  │  Remote Data   │     │   Conflict   │     │  IndexedDB  │                         │
│  │                │     │  Resolution  │     │             │                         │
│  │ For each item ─┼────►│ Compare UTC  │────►│   Update    │                         │
│  │                │     │ timestamps   │     │   or Skip   │                         │
│  └────────────────┘     └──────────────┘     └─────────────┘                         │
│                               │                      │                                 │
│                               ▼                      ▼                                 │
│                         If remote wins         Clear related                           │
│                                               queue items                              │
│                                                                                         │
│  Step 4: processQueue (处理同步队列)                                                    │
│  ┌────────────────┐                                                                   │
│  │  SyncQueue     │                                                                   │
│  │                │     ┌─────────────────────────────────────────┐                 │
│  │ pending items  │────►│ For each item:                          │                 │
│  │                │     │                                          │                 │
│  └────────────────┘     │ if entityType === 'task':              │                 │
│                         │ 则通过 Supabase 查询本任务的外键任务列表id是否已存在云端     │                 │
│                         │   ┌────────────┐     ┌──────────────┐ │                 │
│                         │   │ Supabase   │     │ TaskList     │ │                 │
│                         │   │ Query      │────►│ Exists?      │ │                 │
│                         │   └────────────┘     └──────────────┘ │                 │
│                         │                             │          │                 │
│                         │                        Yes  │  No      │                 │
│                         │                             ▼  ▼       │                 │
│                         └─────────────────────────────┼──┼───────┘                 │
│                                                       │  │                          │
│                                                       │  └──────────────┐           │
│                                                       │                 │           │
│           ┌───────────────────────────────────────────┘                 │           │
│           ▼                                                             ▼           │
│  ┌──────────────┐     ┌─────────────┐     ┌─────────────┐      ┌───────────┐    │
│  │  Process     │     │  Supabase   │     │   Status    │      │  Skip     │    │
│  │  sync() API  │────►│   INSERT/   │────►│  completed  │      │  Keep     │    │
│  │              │     │   UPDATE    │     │      ✓      │      │  pending  │    │
│  └──────────────┘     └─────────────┘     └─────────────┘      └───────────┘    │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

4️⃣ 登录后的正常操作流程（Authenticated Mode）
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│   用户操作          IndexedDB         SyncQueue         Background Sync    Supabase     │
│   ┌─────┐         ┌──────────┐      ┌─────────┐       ┌──────────┐     ┌─────────┐   │
│   │ ADD │    1    │ tasks    │  2   │ pending │   3   │ process  │  4  │ tables  │   │
│   │TASK │ ───────►│ userId:  │─────►│ action: │──────►│ queue    │────►│ synced  │   │
│   └─────┘ instant │ 123      │ add  │ 'add'   │ async │          │     └─────────┘   │
│            update └──────────┘      └─────────┘       └──────────┘                    │
│                                                              │                          │
│                                                              ▼                          │
│                                                        Network Error?                   │
│                                                              │                          │
│                                                     ┌────────┴────────┐                 │
│                                                     │                 │                 │
│                                                   Success          Retry 3x             │
│                                                     │                 │                 │
│                                                     ▼                 ▼                 │
│                                                 completed          failed               │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

5️⃣ 离线/在线切换（Offline/Online Toggle）
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                         │
│   离线操作                    队列累积                     网络恢复自动同步               │
│   ┌─────┐                 ┌─────────┐                 ┌──────────────┐                │
│   │USER │    No Network   │ Queue   │    Online       │ Auto Process │                │
│   │OPS  │ ───────────────►│ grows   │ ───────────────►│ All Pending  │                │
│   └─────┘                 │ locally │    Event        │ Items        │                │
│                           └─────────┘                 └──────────────┘                │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

关键点说明：
• userId管理：未登录时为null，登录后更新为实际用户ID
• 墓碑模式：deleted字段 0=正常 1=收纳箱 2=永久删除（墓碑）
• LWW冲突解决：基于UTC时间戳，较新的数据获胜
• 队列状态：pending → processing → completed/failed
• 网络恢复：自动检测并处理累积的同步队列